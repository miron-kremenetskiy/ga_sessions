/* Unnesting hits for easier and more in depth analysis in downstream models. */

with unnest_hits as (

  select
    md5(cast(ga.fullvisitorid as string) || cast(ga.visitid as string)) as session_id
    , ga.fullvisitorid
    , ga.visitid
    , timestamp_seconds(ga.visitStartTime) as visit_start_at
    , timestamp_seconds(cast(ga.visitStartTime + (hits_unnested.time / 1000) as int64)) as hit_at
    , hits_unnested.hitnumber
    , (select v2ProductCategory from unnest(hits_unnested.product)) as product_category
    , hits_unnested.eventInfo.eventAction as event_action
    , hits_unnested.type as hit_type
    , ga.totals.transactions as transactions
  from `bigquery-public-data.google_analytics_sample.ga_sessions_20170801` as ga
    , unnest(hits) as hits_unnested

)

select * from unnest_hits
